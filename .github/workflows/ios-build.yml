name: iOS Build with Xcode 16

on:
  push:
    branches:
      - master

jobs:
  build-ios:
    runs-on: macos-15  # macOS-15 이미지를 사용하여 Xcode 16 지원

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Xcode version (Xcode 16)
      - name: Setup Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      # 3. Set up Signing Credentials
      - name: Set up Signing Credentials
        run: |
          echo "${{ secrets.CERTIFICATE_P12_BASE64 }}" | base64 --decode > certificate.p12
          security create-keychain -p "temp_password" temp.keychain
          security import certificate.p12 -k temp.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          mkdir -p ~/Library/Developer/Xcode/UserData/Provisioning\ Profiles
          echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/Developer/Xcode/UserData/Provisioning\ Profiles/YourProfile.mobileprovision

      # 4. Generate ExportOptions.plist
      - name: Generate ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.TEAM_ID }}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.example.app</key>
                  <string>YourProvisioningProfileName</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF

      # 5. Archive iOS App
      - name: Archive iOS App
        run: |
          xcodebuild clean archive \
            -project AiSM_Swift_Fastlane_Github.xcodeproj \
            -scheme AiSM_Swift_Fastlane_Github \
            -archivePath ${{ runner.temp }}/AiSM_Swift_Fastlane_Github.xcarchive \
            CODE_SIGN_STYLE="Manual" \
            DEVELOPMENT_TEAM="${{ secrets.TEAM_ID }}" \
            OTHER_CODE_SIGN_FLAGS="--timestamp=none" \
            CODE_SIGN_IDENTITY="Apple Distribution: Inka Entworks Inc. (22X77ENQ2H)" \
            PROVISIONING_PROFILE_SPECIFIER="AppSealing Wildcard Distribution Profile"

      # 6. Export IPA file with ExportOptions.plist
      - name: Export IPA file
        run: |
          xcodebuild -exportArchive \
            -archivePath ${{ runner.temp }}/AiSM_Swift_Fastlane_Github.xcarchive \
            -exportPath ${{ runner.temp }}/build \
            -exportOptionsPlist ./ExportOptions.plist

      # 7. Upload IPA as Artifact
      - name: Upload IPA as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: AiSM_Swift_Fastlane_Github-IPA
          path: ${{ runner.temp }}/build/*.ipa
